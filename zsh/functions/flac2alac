#!/bin/zsh

##? flac2alac - convert FLAC files to ALAC with tag correction
##?
##? usage: flac2alac ["Artist Name" "Album Name"]
##?        If artist and album are omitted, existing metadata is preserved


# Check if correct number of arguments
if [[ $# -ne 0 && $# -ne 2 ]]; then
    echo "Usage: flac2alac [\"Artist Name\" \"Album Name\"]"
    echo "       Omit arguments to preserve existing metadata"
    return 1
fi

# Check if ffmpeg is installed
if ! command -v ffmpeg &> /dev/null; then
    echo "Error: ffmpeg is not installed"
    return 1
fi

local artist="$1"
local album="$2"
local converted=0
local failed=0
local override_metadata=false

# Check if metadata should be overridden
if [[ $# -eq 2 ]]; then
    override_metadata=true
fi

# Check if any FLAC files exist
if ! ls *.flac &> /dev/null; then
    echo "No FLAC files found in current directory"
    return 1
fi

echo "Converting FLAC files to ALAC..."
if [[ $override_metadata == true ]]; then
    echo "Artist: $artist"
    echo "Album: $album"
else
    echo "Preserving existing metadata"
fi
echo ""

for file in *.flac; do
    if [[ -f "$file" ]]; then
        local output="${file%.flac}.m4a"
        echo -n "Converting: $file... "

        # Build ffmpeg command based on whether to override metadata
        if [[ $override_metadata == true ]]; then
            # Convert with custom tags
            if ffmpeg -i "$file" -c:a alac -c:v copy \
                      -metadata artist="$artist" \
                      -metadata albumartist="$artist" \
                      -metadata album="$album" \
                      "$output" -loglevel error 2>&1; then
                rm "$file"
                echo "✓"
                ((converted++))
            else
                echo "✗"
                ((failed++))
            fi
        else
            # Convert while preserving all existing metadata
            if ffmpeg -i "$file" -c:a alac -c:v copy \
                      "$output" -loglevel error 2>&1; then
                rm "$file"
                echo "✓"
                ((converted++))
            else
                echo "✗"
                ((failed++))
            fi
        fi
    fi
done

echo ""
echo "Conversion complete: $converted successful, $failed failed"
