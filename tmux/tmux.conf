# ~/.tmux.conf

# Tmux Plugin Manager
# See: https://github.com/tmux-plugins/tpm

# Install plugins in the XDG path
set-environment -g TMUX_PLUGIN_MANAGER_PATH '~/.config/tmux/plugins'

# Plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'accessd/tmux-agent-indicator'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'soyuka/tmux-current-pane-hostname'
set -g @plugin 'wfxr/tmux-fzf-url'
set -g @plugin 'sainnhe/tmux-fzf'

# See: https://jdhao.github.io/2018/10/19/tmux_nvim_true_color/
set -g default-terminal "screen-256color"
set -as terminal-features ",xterm-256color:RGB"
set -as terminal-features ',xterm-kitty:RGB'
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # undercurl color support

# Status bar at top
set-option -g status-position top

# No bells at all
set -g bell-action none

# Scroll History
set -g history-limit 10000

# Set ability to capture on start and restore on exit window data when running an application
setw -g alternate-screen on

# Lower escape timing from 500ms to 50ms for quicker response to scroll-buffer access.
set -s escape-time 50

# Index at 1 instead of 0
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1

# send the prefix to client inside window
bind-key -n C-g send-prefix

# Some motion keys to make switching windows faster
bind -n S-Right next-window
bind -n S-Left previous-window

# Bind r to reloading the configuration
bind r source-file ~/.config/tmux/tmux.conf \; display "~/.config/tmux/tmux.conf sourced"

# Auto-name new sessions "main" if no session named "main" exists
set-hook -g session-created 'run-shell "if ! tmux has-session -t main 2>/dev/null && [ \"#{session_name}\" != \"main\" ]; then tmux rename-session main; fi"'

# Bind Shift-s to creating a new named session
bind S command-prompt -p "New Session:" "new-session -A -s '%%'"
# Bind Shift-k to killing current session
bind K confirm kill-session
# Bind C-f to finding windows
bind C-f command-prompt -p find-session "switch-client -t %%"

# Start new pans in the same working directory
bind c new-window -c "#{pane_current_path}"
# Some binds for easier splits
bind | split-window -h -c "#{pane_current_path}"
bind _ split-window -v -c "#{pane_current_path}"
bind \\ split-window -h -p 33 -c "#{pane_current_path}"

# Easy resizing of panes
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r H resize-pane -L 5
bind -r L resize-pane -R 5

# Nice window behavior
setw -g automatic-rename on   # rename window to reflect current program
set -g renumber-windows on    # renumber windows when a window is closed
set -g status-interval 1      # redraw status line every 1 second for more responsive updates

# Turn the mouse on, but without copy mode dragging
set -g mouse on
# unbind -n MouseDrag1Pane
# unbind -Tcopy-mode MouseDrag1Pane

# Keys to toggle monitoring activity in a window and the synchronize-panes option
bind m set monitor-activity
bind y set synchronize-panes\; display 'synchronize-panes #{?synchronize-panes,on,off}'
# setw -g monitor-activity on
# set -g visual-activity on

# tmux-fzf-url configuration
# Searches for URLs, passes them through FZF and lets me pick the one to open
set -g @fzf-url-bind 'u'

# tmux-agent-indicator configuration
# Enable/disable visual channels
set -g @agent-indicator-border-enabled 'on'
set -g @agent-indicator-indicator-enabled 'on'

# Per-agent icons
# set -g @agent-indicator-icons 'claude=ðŸ¤–,codex=ðŸ§ ,default=ðŸ¤–'

# Keep pane colors until you focus the pane (instead of clearing immediately)
set -g @agent-indicator-reset-on-focus 'on'

# Knight Rider animation while running
# set -g @agent-indicator-animation-enabled 'on'

# State colors (VHS Era palette)
set -g @agent-indicator-running-bg ''
set -g @agent-indicator-running-border ''
set -g @agent-indicator-needs-input-bg '#ffcc66'
set -g @agent-indicator-needs-input-border '#ffcc66'
set -g @agent-indicator-needs-input-window-title-bg '#ffcc66'
set -g @agent-indicator-needs-input-window-title-fg '#161616'
set -g @agent-indicator-done-bg ''
set -g @agent-indicator-done-border '#42be65'
set -g @agent-indicator-done-window-title-bg '#42be65'
set -g @agent-indicator-done-window-title-fg '#161616'

# VHS Era Theme
source-file ~/.config/tmux/theme.conf

# POPUP WINDOWS
# These two shortcuts provide popup windows in tmux.
#
# The lowercase version makes a local popup window. If you're in a git project
# it will name the popup after the git project and fresh shells will be made at
# the root of the git project. Otherwise it names the shell after the working
# directory.
#
# The uppercase version makes a "global" popup window. Great for persisting
# things globally for a long period of time.
bind g run-shell '\
    POPUP_INFO=$(~/.config/tmux/git-aware-popup.sh "#{pane_current_path}"); \
    POPUP_DIR=$(echo "$POPUP_INFO" | cut -d"|" -f1); \
    POPUP_NAME=$(echo "$POPUP_INFO" | cut -d"|" -f2); \
    if [ "#{session_name}" = "$POPUP_NAME" ]; then \
        tmux detach-client; \
    else \
        tmux display-popup -d "$POPUP_DIR" -xC -yC -w 80% -h 75% -E "tmux attach-session -t $POPUP_NAME || tmux new-session -s $POPUP_NAME"; \
    fi \
'

bind G run-shell '\
    POPUP_NAME="popup-global"; \
    if [ "#{session_name}" = "$POPUP_NAME" ]; then \
        tmux detach-client; \
    else \
        tmux display-popup -xC -yC -w 80% -h 75% -E "tmux attach-session -t $POPUP_NAME || tmux new-session -s $POPUP_NAME"; \
    fi \
'

# This needs to be last always
run '~/.config/tmux/plugins/tpm/tpm'
